{#
    This file is part of the CloudStack Client Generator.

    (c) Quentin Pleplé <quentin.pleple@gmail.com>
    (c) Aaron Hurt <ahurt@anbcs.com>
    (c) Nathan Johnson <nathan@nathanjohnson.info>
    (c) Daniel Carbone <daniel.p.carbone@gmail.com>
    (c) Bogdan Gabor <bgabor@ena.com>

    For the full copyright and license information, please view the LICENSE
    file that was distributed with this source code.
#}
{% autoescape false %}
<?php{% if config.namespace != '' %} namespace {{ config.namespace }};{% endif %}

/*
 * This file was autogenerated as part of the CloudStack PHP Client.
 *
 * Date Generated: {{ config.now.format('Y-m-d') }}
 * API Version: {{ capabilities.capability.cloudstackversion }}
 *
 * (c) Quentin Pleplé {{ '<quentin.pleple@gmail.com>'|raw }}
 * (c) Aaron Hurt {{ '<ahurt@anbcs.com>'|raw }}
 * (c) Nathan Johnson {{ '<nathan@nathanjohnson.org>'|raw }}
 * (c) Daniel Carbone {{ '<daniel.p.carbone@gmail.com>'|raw }}
 * (c) Bogdan Gabor {{ '<bgabor@ena.com>'|raw }}
 *
 * For the full copyright and license information, please view the LICENSE
 * file that was distributed with this source code.
 */

use GuzzleHttp\Psr7\Request;
use GuzzleHttp\Psr7\Uri;

/**
 * CloudStackCommandAbstract Class
 * @package {% if config.namespace != '' %}\{{ config.namespace }}{% endif %}
 */
abstract class CloudStackCommandAbstract {

    /** @var CloudStackConfiguration */
    private $configuration;

    /**
     * Name of command itself
     * @var string
     */
    private $command;

    /**
     * Map of parameters to pass to CloudStack
     * @var array
     */
    private $parameters = [];

    /**
     * Map of key-sorted parameters with "command" key added
     * @var array
     */
    private $compiledParameters = [];

    /**
     * Ready-to-execute represetation of command
     * @var string
     */
    private $compiledQuery = '';

    /**
     * CloudStackCommandAbstract Constructor
     * @var \{% if config.namespace != '' %}{{ config.namespace }}\{% endif %}CloudStackConfiguration $configuration
     * @var string $command
     * @var array $parameters
     */
    public function __construct(CloudStackConfiguration $configuration, $command, array $parameters = []) {
        $this->configuration = $configuration;

        if (!is_string($command)) {
            throw new \InvalidArgumentException(sprintf(WRONG_ARGUMENT_TYPE_MSG, 'command', 'string', gettype($command)), WRONG_ARGUMENT_TYPE);
        }

        $this->command = trim((string)$command);

        if ('' === $this->command) {
            throw new \InvalidArgumentException(sprintf(WRONG_ARGUMENT_TYPE_MSG, 'command', 'non-empty string', ''), WRONG_ARGUMENT_TYPE);
        }

        $params = [];
        foreach($parameters as $k => $v) {
            // if we see a null value, just move on.
            if (null === $v) {
                continue;
            }

            // otherwise, attempt to "stringify" it.
            $paramStr = null;
            switch(gettype($v)) {
                case 'boolean':
                    $paramStr = $v ? 'true' : 'false';
                    break;
                case 'integer':
                case 'double':
                    $paramStr = strval($v);
                    break;
                case 'string':
                    $paramStr = $v;
                    break;
                case 'array':
                    $paramStr = CloudStackHelpers::formatCSQueryArray($v, $k);
                    break;
                case 'object':
                    $paramStr = CloudStackHelpers::formatCSQueryArray(json_decode(json_encode($v), true), $k);
            }

            if (!is_string($paramStr)) {
                throw new \InvalidArgumentException(sprintf(
                        WRONG_ARGUMENT_TYPE_MSG,
                        $k,
                        'scalar type, array, or \\stdClass object',
                        gettype($v)
                ), WRONG_ARGUMENT_TYPE);
            }

            if ('' === $paramStr) {
                continue;
            }

            $params[strtolower($k)] = $paramStr;
        }

        $this->parameters = $params;
    }

    /**
     * @return \{% if config.namespace != '' %}{{ config.namespace }}\{% endif %}CloudStackConfiguration
     */
    public function getConfiguration() {
        return $this->configuration;
    }

    /**
     * @return string
     */
    abstract public function getKey();

    /**
     * @return string
     */
    abstract public function getPath();

    /**
     * @return string
     */
    public function getCommand() {
        return $this->command;
    }

    /**
     * @return array
     */
    public function getParameters() {
        if (0 === count($this->compiledParameters)) {
            $this->compiledParameters = [
                'apikey' => $this->configuration->getApiKey(),
                $this->getKey() => $this->getCommand(),
                'response' => 'json',
            ] + $this->parameters;
            ksort($this->compiledParameters);
        }

        return $this->compiledParameters;
    }

    /**
     * @return string
     */
    public function getCompiledQuery() {
        if ('' === $this->compiledQuery) {
            $query = http_build_query($this->getParameters(), '', '&', PHP_QUERY_RFC3986);
            $this->compiledQuery = sprintf('%s&signature=%s', $query, $this->configuration->buildSignature($query));
        }

        return $this->compiledQuery;
    }

    /**
     * @return \GuzzleHttp\Psr7\Request
     */
    public function createPsr7Request() {
        static $headers = ['Accept' => ['application/json'], 'Content-Type' => ['application/x-www-form-urlencoded']];

        $stream = fopen('php://memory', 'w+');
        fwrite($stream, $this->getCompiledQuery());

        return new Request(
            'POST',
            new Uri(sprintf('%s/%s', $this->configuration->getCompiledAddress(), $this->getPath())),
            $headers,
            $stream
        );
    }

    /**
     * @return string
     */
    public function __toString() {
        return $this->getCompiledQuery();
    }
}
{% endautoescape %}